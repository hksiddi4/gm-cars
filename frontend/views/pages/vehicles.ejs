<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head'); %>    
    <title>Vehicles</title>
</head>
<body>
    <%- include('../partials/header'); %>
    <div class="custom-container">
        <div class="row" style="padding-top: 20px;">
            <!-- Filters -->
            <div class="col-md-6">
                <div id="filterToggle" class="d-inline-flex align-items-center">
                    <h4 class="mb-0">Filter</h4>
                    <i class="fas fa-sort-down" id="filterIcon" style="color: white;"></i>
                </div>
                <div id="filterContent" class="collapse">
                    <form id="filterForm">
                        <% models.forEach(function(model) { %>
                            <div class="form-check">
                                <input 
                                    class="form-check-input" 
                                    type="checkbox" 
                                    id="model_<%= model %>" 
                                    value="<%= model %>"
                                    <%= selectedModels.includes(model) ? 'checked' : '' %>
                                >
                                <label class="form-check-label" for="model_<%= model %>">
                                    <%= model %>
                                </label>
                            </div>
                        <% }) %>
                        <button type="submit" class="btn btn-primary mt-2">Apply Filters</button>
                        <button type="button" id="clearFilters" class="btn btn-secondary mt-2">Clear All</button>
                    </form>
                </div>
            </div>
            <!-- RPO Search -->
            <div class="col-md-4 mt-2 position-relative">
                <input type="text" id="rpoSearchInput" class="form-control" placeholder="Search RPOs..." />
                <ul id="rpoResults" class="list-group mt-2" style="max-height: 200px; overflow-y: auto;"></ul>
                <div id="selectedRPOs" class="selected-rpos mt-1"></div>
            </div>
            <div class="stats d-flex justify-content-between align-items-end" style="margin-top: 5px; margin-bottom: 10px;">
                <p style="color: rgb(103, 103, 103); margin: 0;">
                    Retrieved <%= totalItems.toLocaleString() %> vehicles in <%= elapsedTime.toLocaleString() %> seconds
                </p>
                <div class="dropdown-container">
                    <select id="limitSelect" class="form-select small-dropdown">
                        <option value="100" <% if (limit === 100) { %>selected<% } %>>100</option>
                        <option value="150" <% if (limit === 150) { %>selected<% } %>>150</option>
                        <option value="200" <% if (limit === 200) { %>selected<% } %>>200</option>
                        <option value="250" <% if (limit === 250) { %>selected<% } %>>250</option>
                    </select>
                </div>
            </div>
            <!-- Vehicles Table -->
            <div class="table-responsive" style="overflow-x: auto;">
                <% if (vehicle_data) { %>
                <table class="table-veh table-hover border border shadow" id="allTable">
                    <thead>
                        <tr>
                            <th scope="col" id="vinHeader" class="sortable" onclick="toggleVINOrder()" style="cursor: pointer;">
                                VIN
                                <i class="fas fa-sort-down" id="vinIcon" style="display: none;"></i>
                            </th>
                            <th scope="col">
                                <div class="dropdown-container">
                                    <select id="yearSelect" class="form-select small-dropdown <%= selectedYear ? 'active-filter' : '' %>">
                                        <option value="">Year</option>
                                        <% years.forEach(function(year) { %>
                                            <option value="<%= year %>" <% if (selectedYear === year.toString()) { %>selected<% } %>><%= year %></option>
                                        <% }) %>
                                    </select>
                                </div>
                            </th>
                            <th scope="col">Model</th>
                            <th scope="col">
                                <div class="dropdown-container">
                                    <select id="bodySelect" class="form-select small-dropdown <%= selectedBody ? 'active-filter' : '' %>">
                                        <option value="">Body</option>
                                        <% bodys.forEach(function(body) { %>
                                            <option value="<%= body %>" <% if (selectedBody === body.toString()) { %>selected<% } %>><%= body %></option>
                                        <% }) %>
                                    </select>
                                </div>
                            </th>
                            <th scope="col">
                                <div class="dropdown-container">
                                    <select id="trimSelect" class="form-select small-dropdown <%= selectedTrim ? 'active-filter' : '' %>">
                                        <option value="">Trim</option>
                                        <% trim.forEach(function(trim) { %>
                                            <option value="<%= trim %>" <% if (selectedTrim === trim) { %>selected<% } %>><%= trim %></option>
                                        <% }) %>
                                    </select>
                                </div>
                            </th>
                            <th scope="col">
                                <div class="dropdown-container">
                                    <select id="engineSelect" class="form-select small-dropdown <%= selectedEngine ? 'active-filter' : '' %>">
                                        <option value="">Engine</option>
                                        <% engine.forEach(function(engine) { %>
                                            <option value="<%= engine %>" <% if (selectedEngine === engine) { %>selected<% } %>><%= engine %></option>
                                        <% }) %>
                                    </select>
                                </div>
                            </th>
                            <th scope="col">
                                <div class="dropdown-container">
                                    <select id="transSelect" class="form-select small-dropdown <%= selectedTrans ? 'active-filter' : '' %>">
                                        <option value="">Trans.</option>
                                        <% trans.forEach(function(trans) { %>
                                            <option value="<%= trans %>" <% if (selectedTrans === trans) { %>selected<% } %>><%= trans %></option>
                                        <% }) %>
                                    </select>
                                </div>
                            </th>
                            <th scope="col">Drivetrain</th>
                            <th scope="col">
                                <div class="dropdown-container">
                                    <select id="colorSelect" class="form-select small-dropdown <%= selectedColor ? 'active-filter' : '' %>">
                                        <option value="">Exterior Color</option>
                                        <% colors.forEach(function(color) { %>
                                            <option value="<%= color %>" <% if (selectedColor === color) { %>selected<% } %>><%= color %></option>
                                        <% }) %>
                                    </select>
                                </div>
                            </th>
                            <th scope="col" id="msrpHeader" class="sortable" onclick="toggleMSRPOrder()" style="cursor: pointer;">
                                MSRP
                                <i class="fas fa-sort-down" id="msrpIcon" style="display: none;"></i>
                            </th>
                            <th scope="col">
                                <div class="dropdown-container">
                                    <select id="rpoSelect" class="form-select small-dropdown <%= selectedRPO ? 'active-filter' : '' %>">
                                        <% const rpo = Array.isArray(selectedRPO) ? selectedRPO[0] : selectedRPO; %>
                                        <option value="" <% if (!rpo) { %>selected<% } %>>Package/Option</option>
                                        <option value="Z4B" <% if (rpo === 'Z4B') { %>selected<% } %>>Camaro Collector's Edition</option>
                                        <option value="X56" <% if (rpo === 'X56') { %>selected<% } %>>Camaro Garage 56 Special Edition</option>
                                        <option value="WBL" <% if (rpo === 'WBL') { %>selected<% } %>>Redline Edition</option>
                                        <option value="B2E" <% if (rpo === 'B2E') { %>selected<% } %>>Shock and Steel Edition</option>
                                        <option value="H40" <% if (rpo === 'H40') { %>selected<% } %>>Hendrick Motorsports 40th Anniversary Edition</option>
                                        <option value="PEH" <% if (rpo === 'PEH') { %>selected<% } %>>Hertz / Hendrick Motorsports Edition</option>
                                        <option value="A1Z" <% if (rpo === 'A1Z') { %>selected<% } %>>ZL1 1LE Extreme Track Performance Package</option>
                                        <option value="A1Y" <% if (rpo === 'A1Y') { %>selected<% } %>>SS 1LE Track Performance Package</option>
                                        <option value="A1X" <% if (rpo === 'A1X') { %>selected<% } %>>LT 1LE Track Performance Package</option>
                                        <option value="ZCR" <% if (rpo === 'ZCR') { %>selected<% } %>>IMSA GTLM Championship C8.R Edition</option>
                                        <option value="Y70" <% if (rpo === 'Y70') { %>selected<% } %>>Corvette Stingray 70th Anniversary Edition</option>
                                        <option value="Z07" <% if (rpo === 'Z07') { %>selected<% } %>>Z07 Performance Package</option>
                                        <option value="Z51" <% if (rpo === 'Z51') { %>selected<% } %>>Z51 Performance Package</option>
                                        <option value="ZTK" <% if (rpo === 'ZTK') { %>selected<% } %>>ZTK Track Performance Package</option>
                                        <option value="ZLE" <% if (rpo === 'ZLE') { %>selected<% } %>>CT4-V Blackwing Watkins Glen IMSA Edition</option>
                                        <option value="ZLD" <% if (rpo === 'ZLD') { %>selected<% } %>>CT4-V Blackwing Sebring IMSA Edition</option>
                                        <option value="ZLG" <% if (rpo === 'ZLG') { %>selected<% } %>>CT4-V Blackwing Road Atlanta IMSA Edition</option>
                                        <option value="ZLK" <% if (rpo === 'ZLK') { %>selected<% } %>>CT4-V Blackwing Arrival Edition</option>
                                        <option value="ZLJ" <% if (rpo === 'ZLJ') { %>selected<% } %>>CT4-V Blackwing Impact Edition</option>
                                        <option value="ZLR" <% if (rpo === 'ZLR') { %>selected<% } %>>CT4-V Blackwing Elevation Edition</option>
                                        <option value="ABQ" <% if (rpo === 'ABQ') { %>selected<% } %>>CT5-V Blackwing 120th Anniversary Edition</option>
                                        <option value="ZLT" <% if (rpo === 'ZLT') { %>selected<% } %>>CT5-V Blackwing 20th Anniversary Edition</option>
                                        <option value="OAR" <% if (rpo === 'OAR') { %>selected<% } %>>Pre-Production Vehicle</option>
                                    </select>
                                </div>
                            </th>
                            <th scope="col">
                                <div class="dropdown-container">
                                    <select id="countrySelect" class="form-select small-dropdown <%= selectedCountry ? 'active-filter' : '' %>">
                                        <option value="">Country</option>
                                        <option value="USA" <% if (selectedCountry === 'USA') { %>selected<% } %>>USA</option>
                                        <option value="CAN" <% if (selectedCountry === 'CAN') { %>selected<% } %>>Canada</option>
                                        <% if (models.includes("CAMARO")) { %>
                                            <option value="MEX" <% if (selectedCountry === 'MEX') { %>selected<% } %>>Mexico</option>
                                        <% } %>
                                    </select>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <% vehicle_data.forEach(function(data) { %>
                            <tr style="cursor: pointer;" onmousedown="handleMouseDown(event);" data-url="/search?vin=<%= data.vin %>">
                                <td scope="row" style="text-align: left;" class="<%= data.special_desc && data.special_desc.includes('Pre-Production Vehicle') ? 'highlight' : '' %>"><%= data.vin %></td>
                                <td scope="row"><%= data.modelYear %></td>
                                <td scope="row"><%= data.model %></td>
                                <td scope="row"><%= data.body %></td>
                                <td scope="row"><%= data.trim %></td>
                                <td scope="row"><%= data.engine_type %></td>
                                <td scope="row"><%= data.transmission_type %></td>
                                <td scope="row"><%= data.drivetrain_type %></td>
                                <td scope="row" style="text-align: left; align-items: center;">
                                    <img id="sample" src="../img/extColors/<%= colorMap[data.color_name] || '../extColors/default' %>.png" width="20" height="20" style="margin-right: 8px; border-radius: 50%;">
                                    <%= data.color_name %>
                                </td>
                                <td scope="row" class="accounting-format">
                                    <% if (data.msrp == 0) { %>
                                        <span></span>
                                        <span>N/A</span>
                                    <% } else { %>
                                        <span>$</span>
                                        <span><%= data.msrp %></span>
                                    <% } %>
                                </td>
                                <td scope="row"><%= data.special_desc %></td>
                                <td scope="row">
                                    <% if (data.country == "USA") { %>
                                        <img src="../img/flags/usa_flag.png" alt="USA" width="20">
                                    <% } else if (data.country == "CANADA") { %>
                                        <img src="../img/flags/canada_flag.png" alt="Canada" width="20">
                                    <% } else { %>
                                        <img src="../img/flags/mexico_flag.png" alt="Mexico" width="20">
                                    <% } %>                                    
                                </td>
                                <!-- <td scope="row" style="text-align: left;"><%= data.dealer_name || 'N/A' %></td> -->
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
            <!-- Pagination -->
            <%
            function buildQuery(params) {
                const entries = Object.entries(params)
                    .filter(([_, v]) => v !== undefined && v !== null && v !== '');

                // Move 'page' to the end
                const pageEntry = entries.find(([k]) => k === 'page');
                const filtered = entries.filter(([k]) => k !== 'page');
                if (pageEntry) filtered.push(pageEntry);

                return filtered
                    .map(([k, v]) => `${k}=${encodeURIComponent(v)}`)
                    .join('&');
            }

            const baseQuery = {
                limit,
                model: selectedModels.length ? selectedModels.join(',') : '',
                rpo: selectedRPO,
                trim: selectedTrim,
                engine: selectedEngine,
                trans: selectedTrans,
                year: selectedYear,
                body: selectedBody,
                color: selectedColor,
                country: selectedCountry,
                order: selectedOrder
            };
            %>
            <div class="pagination-wrapper">
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        <% if (currentPage > 1) { %>
                            <!-- First Page -->
                            <li class="page-item">
                                <a class="page-link" href="?<%= buildQuery({ ...baseQuery, page: 1 }) %>">First</a>
                            </li>
                            <!-- Previous Page -->
                            <li class="page-item">
                                <a class="page-link" href="?<%= buildQuery({ ...baseQuery, page: currentPage - 1 }) %>">Previous</a>
                            </li>
                        <% } %>
                        <!-- Page Numbers -->
                        <% 
                        const pageRange = 7; // Number of pages to show around the current page
                        let startPage = Math.max(1, currentPage - Math.floor(pageRange / 2));
                        let endPage = Math.min(totalPages, currentPage + Math.floor(pageRange / 2));

                        if (currentPage - Math.floor(pageRange / 2) < 1) {
                            endPage = Math.min(totalPages, endPage + (1 - (currentPage - Math.floor(pageRange / 2))));
                        }

                        if (currentPage + Math.floor(pageRange / 2) > totalPages) {
                            startPage = Math.max(1, startPage - ((currentPage + Math.floor(pageRange / 2)) - totalPages));
                        }
                        %>
                        <% for (let i = startPage; i <= endPage; i++) { %>
                            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                <a class="page-link" href="?<%= buildQuery({ ...baseQuery, page: i }) %>"><%= i %></a>
                            </li>
                        <% } %>
                        <% if (currentPage < totalPages) { %>
                            <!-- Next Page -->
                            <li class="page-item">
                                <a class="page-link" href="?<%= buildQuery({ ...baseQuery, page: currentPage + 1 }) %>">Next</a>
                            </li>
                            <!-- Last Page -->
                            <li class="page-item">
                                <a class="page-link" href="?<%= buildQuery({ ...baseQuery, page: totalPages }) %>">Last</a>
                            </li>
                        <% } %>
                    </ul>
                </nav>
            </div>
            <% } %>
        </div>
    </div>
    <%- include('../partials/footer'); %>
    <script>
        let startX;
        let selectedOrder = '';

        let rpoDescriptions = {};

        const cachedRPO = sessionStorage.getItem('rpoCodes');

        if (cachedRPO) {
            const data = JSON.parse(cachedRPO);
            data.allRpoCodes.forEach(([code, desc]) => {
                rpoDescriptions[code] = desc;
            });
            renderSelectedRPOs();
        } else {
            fetch('https://decoderpo.com/static/rpoCodes.json')
                .then(res => res.json())
                .then(data => {
                    sessionStorage.setItem('rpoCodes', JSON.stringify(data));
                    data.allRpoCodes.forEach(([code, desc]) => {
                        rpoDescriptions[code] = desc;
                    });
                    renderSelectedRPOs();
                })
                .catch(err => {
                    console.error('Failed to load RPO data:', err);
                });
        }

        function buildQueryString(params) {
            const queryStrings = Object.entries(params)
                .filter(([key, value]) => value)
                .map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`)
                .join('&');
            return queryStrings;
        }

        function toggleOrder(type, ascValue, descValue, iconId) {
            selectedOrder = selectedOrder === ascValue ? descValue : ascValue;
            document.getElementById(iconId).className = selectedOrder === ascValue ? 'fas fa-sort-up' : 'fas fa-sort-down';
            const params = new URLSearchParams(window.location.search);
            params.set('order', selectedOrder);
            window.location.search = params.toString();
        }

        function toggleMSRPOrder() {
            toggleOrder("msrp", "ASC", "DESC", "msrpIcon");
        }

        function toggleVINOrder() {
            toggleOrder("vin", "vinASC", "vinDESC", "vinIcon");
        }

        function handleMouseDown(event) {
            startX = event.clientX;
        }

        function handleRowClick(url, event) {
            const distance = Math.abs(event.clientX - startX);
            if (distance > 5) {
                return;
            }
            window.location.href = url;
        }

        function addSelectListener(selectId, paramName) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;

            selectElement.addEventListener('change', function(event) {
                const value = event.target.value;
                const url = new URL(window.location.href);
                url.searchParams.set(paramName, value);
                url.searchParams.set('page', 1);
                window.location.href = url.toString();
            });
        }

        function updateIcons(selectedOrder) {
            const vinIcon = document.getElementById('vinIcon');
            const msrpIcon = document.getElementById('msrpIcon');

            function setIcon(iconElement, iconType, condition) {
                iconElement.className = condition ? `fas fa-sort-${iconType}` : '';
                iconElement.style.display = condition ? 'inline' : 'none';
            }
            setIcon(msrpIcon, selectedOrder === 'ASC' ? 'up' : 'down', selectedOrder === 'ASC' || selectedOrder === 'DESC');
            setIcon(vinIcon, selectedOrder === 'vinASC' ? 'up' : 'down', selectedOrder === 'vinASC' || selectedOrder === 'vinDESC');
        }

        function renderSelectedRPOs() {
            const container = document.getElementById('selectedRPOs');
            container.innerHTML = '';
            const url = new URL(window.location.href);
            const rpoParam = url.searchParams.get('rpo');
            if (!rpoParam) return;
            const rpos = rpoParam.split(',');

            rpos.forEach(code => {
                const tag = document.createElement('button');
                tag.type = 'button';
                tag.className = 'rpo-tag';

                const desc = rpoDescriptions[code] || 'No description';
                tag.innerHTML = `<strong>${code}</strong>: ${desc} &nbsp;×`;

                tag.addEventListener('click', () => {
                    const newRpos = rpos.filter(r => r !== code);
                    const url = new URL(window.location.href);
                    if (newRpos.length) {
                        url.searchParams.set('rpo', newRpos.join(','));
                    } else {
                        url.searchParams.delete('rpo');
                    }
                    url.searchParams.set('page', 1);
                    window.location.href = url.toString();
                });

                container.appendChild(tag);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const filterToggle = document.getElementById('filterToggle');
            const filterContent = document.getElementById('filterContent');
            const filterIcon = document.getElementById('filterIcon');
            const clearFilters = document.getElementById('clearFilters');
            const rpoSelect = document.getElementById('rpoSelect');
            const yearSelect = document.getElementById('yearSelect');
            const bodySelect = document.getElementById('bodySelect');
            const trimSelect = document.getElementById('trimSelect');
            const engineSelect = document.getElementById('engineSelect');
            const transSelect = document.getElementById('transSelect');
            const colorSelect = document.getElementById('colorSelect');
            const countrySelect = document.getElementById('countrySelect');
            const orderSelect = document.getElementById('orderSelect');
            const filterForm = document.getElementById('filterForm');
            const limitSelect = document.getElementById('limitSelect');
            const currentOrder = new URLSearchParams(window.location.search).get('order');
            selectedOrder = currentOrder;
            updateIcons(selectedOrder);

            const rpoSearchInput = document.getElementById('rpoSearchInput');
            const rpoResults = document.getElementById('rpoResults');

            rpoSearchInput.addEventListener('input', function() {
                const query = rpoSearchInput.value.toUpperCase().trim();
                rpoResults.innerHTML = '';

                if (query.length > 1) {
                    const matchingRPOs = Object.entries(rpoDescriptions).filter(([rpo, description]) =>
                        rpo.includes(query) || description.toLowerCase().includes(query.toLowerCase())
                    );

                    matchingRPOs.forEach(([rpo, description]) => {
                        const li = document.createElement('li');
                        li.classList.add('list-group-item');
                        const highlightedRpo = rpo.replace(new RegExp(query, 'gi'), match => `<span class="highlight">${match}</span>`);
                        const highlightedDescription = description.replace(new RegExp(query, 'gi'), match => `<span class="highlight">${match}</span>`);
                        li.innerHTML = `<strong>${rpo}</strong>: ${highlightedDescription}`;
                        
                        li.style.cursor = 'pointer';
                        li.addEventListener('click', () => {
                            const url = new URL(window.location.href);
                            const currentRPO = url.searchParams.get('rpo');
                            let newRPO;

                            if (currentRPO) {
                                const rpoSet = new Set(currentRPO.split(','));
                                rpoSet.add(rpo);
                                newRPO = Array.from(rpoSet).join(',');
                            } else {
                                newRPO = rpo;
                            }

                            url.searchParams.set('rpo', newRPO);
                            window.location.href = url.toString();
                        });

                        rpoResults.appendChild(li);
                    });
                }
            });

            filterToggle.addEventListener('click', function() {
                if (filterContent.classList.contains('show')) {
                    filterContent.classList.remove('show');
                    filterIcon.classList.remove('rotate');
                } else {
                    filterContent.classList.add('show');
                    filterIcon.classList.add('rotate');
                }
            });

            clearFilters.addEventListener('click', function() {
                window.location.href = '/vehicles';
            });

            const rpoSelectElement = document.getElementById('rpoSelect');
            if (rpoSelectElement) {
                rpoSelectElement.addEventListener('change', function(event) {
                    const value = event.target.value;
                    const url = new URL(window.location.origin + window.location.pathname);
                    if (value) {
                        url.searchParams.set('rpo', value);
                    }
                    window.location.href = url.toString();
                });
            }
            addSelectListener('yearSelect', 'year');
            addSelectListener('bodySelect', 'body');
            addSelectListener('trimSelect', 'trim');
            addSelectListener('engineSelect', 'engine');
            addSelectListener('transSelect', 'trans');
            addSelectListener('colorSelect', 'color');
            addSelectListener('countrySelect', 'country');
            addSelectListener('limitSelect', 'limit');

            filterForm.addEventListener('submit', function(event) {
                event.preventDefault();

                const params = new URLSearchParams();

                const checkboxes = filterForm.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    if (cb.checked) params.append('model', cb.value);
                });

                const addIfNotEmpty = (key, value) => {
                    if (value) params.set(key, value);
                };

                addIfNotEmpty('rpo', rpoSelect.value);
                addIfNotEmpty('year', yearSelect.value);
                addIfNotEmpty('body', bodySelect.value);
                addIfNotEmpty('trim', trimSelect.value);
                addIfNotEmpty('engine', engineSelect.value);
                addIfNotEmpty('trans', transSelect.value);
                addIfNotEmpty('color', colorSelect.value);
                addIfNotEmpty('country', countrySelect.value);
                addIfNotEmpty('limit', limitSelect.value);
                addIfNotEmpty('order', selectedOrder);

                window.location.href = `/vehicles?${params.toString()}`;
            });

            document.querySelectorAll('#allTable tbody tr').forEach(row => {
                const url = row.getAttribute('data-url');
                row.addEventListener('mousedown', handleMouseDown);
                row.addEventListener('click', (event) => handleRowClick(url, event));
            });
        });
    </script>
</body>
</html>
