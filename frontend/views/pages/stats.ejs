<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head'); %>
    <title>Stats</title>
</head>
<body>
    <%- include('../partials/header'); %>
    <div class="container">
        <div class="row pt-4">
            <div class="col">
                <h1 style="font-weight: bold;">Statistics</h1>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-md-2">
                <select id="selectedStats" class="form-select">
                    <option value="">Category</option>
                    <option value="color" <% if (category === 'color') { %> selected <% } %>>Color</option>
                </select>
            </div>
        </div>
        <div class="row mb-2">
            <% if (category) { %>
                <div class="col-md-2">
                    <select id="selectedYear" class="form-select">
                        <option value="">Year</option>
                        <% years.forEach(function(year) { %>
                            <option value="<%= year %>" <% if (selectedYear == year.toString()) { %> selected <% } %>><%= year %></option>
                        <% }) %>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="selectedModel" class="form-select">
                        <option value="">Model</option>
                        <% models.forEach(function(model) { %>
                            <option value="<%= model %>" <% if (selectedModel == model) { %> selected <% } %>><%= model %></option>
                        <% }) %>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="selectedBody" class="form-select">
                        <option value="">Body</option>
                        <% bodys.forEach(function(body) { %>
                            <option value="<%= body %>" <% if (selectedBody == body) { %> selected <% } %>><%= body %></option>
                        <% }) %>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="selectedTrim" class="form-select">
                        <option value="">Trim</option>
                        <% trim.forEach(function(trim) { %>
                            <option value="<%= trim %>" <% if (selectedTrim == trim) { %> selected <% } %>><%= trim %></option>
                        <% }) %>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="selectedEngine" class="form-select">
                        <option value="">Engine</option>
                        <% engine.forEach(function(engine) { %>
                            <option value="<%= engine %>" <% if (selectedEngine == engine) { %> selected <% } %>><%= engine %></option>
                        <% }) %>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="selectedTrans" class="form-select">
                        <% trans.forEach(function(trans) { %>
                            <option value="<%= trans %>" <% if (selectedTrans == trans) { %> selected <% } %>><%= trans %></option>
                        <% }) %>
                    </select>
                </div>
            <% } %>
        </div>
        <% if (stats_data && stats_data.length > 0) { %>
            <canvas id="barChart"></canvas>
            <table class="table-veh table-hover border shadow">
                <thead>
                    <tr>
                        <th scope="col">
                            Rank
                        </th>
                        <th scope="col">
                            RPO
                        </th>
                        <th scope="col">
                            Count
                        </th>
                        <th scope="col">
                            Names
                        </th>
                        <th scope="col">
                            % of Total
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <% stats_data.forEach(function(data) { %>
                        <tr>
                            <td scope="row"><%= data.rank %></td>
                            <td scope="row" style="display: flex; align-items: center;">
                                <img id="sample" src="../img/extColors/<%= data.rpo_code || '../extColors/default' %>.png" width="20" height="20" style="margin-right: 8px; border-radius: 50%;">
                                <%= data.rpo_code %>
                            </td>
                            <td scope="row"><%= data.total_count %></td>
                            <td scope="row" style="text-align: left;"><%= data.color_names %></td>
                            <td scope="row"><%= data.percent %>%</td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } %>
    </div>
    <%- include('../partials/footer'); %>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const statsSelect = document.getElementById('selectedStats');
            const selectedYear = document.getElementById('selectedYear');
            const selectedModel = document.getElementById('selectedModel');
            const selectedBody = document.getElementById('selectedBody');
            const selectedTrim = document.getElementById('selectedTrim');
            const selectedEngine = document.getElementById('selectedEngine');
            const selectedTrans = document.getElementById('selectedTrans');
            
            statsSelect.addEventListener('change', function () {
            const selectedValue = this.value;
            const url = new URL(window.location.href);
            url.searchParams.set('category', selectedValue);
            window.location.href = url.toString();
            });
        });
    </script>
    <% if (stats_data && stats_data.length > 0) { %>
        <script>
        document.addEventListener('DOMContentLoaded', function () {
            const labels = <%- JSON.stringify(stats_data.map(data => data.rpo_code || '')) %>;
            const counts = <%- JSON.stringify(stats_data.map(d => Number(String(d.total_count).replace(/,/g, '')) || 0)) %>;
            const ctx = document.getElementById('barChart').getContext('2d');

            new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Count',
                    data: counts,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    borderRadius: 2,
                    barPercentage: 1,
                    categoryPercentage: 0.8
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                y: {
                    type: 'category',
                    ticks: {
                        autoSkip: false,
                        color: '#ffffff',
                        font: { size: 10 }
                    }
                },
                x: {
                    beginAtZero: true,
                    ticks: {
                        color: '#ffffff',
                        callback: function (value) {
                            if (value >= 1e6) return (value / 1e6).toFixed(1) + 'M';
                            if (value >= 1e3) return (value / 1e3).toFixed(1) + 'k';
                            return value;
                        }
                    }
                }
                },
                plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                    label: ctx => `Count: ${ctx.parsed.x.toLocaleString()}`
                    }
                }
                }
            }
            });
        });
        </script>
    <% } %>
</body>
</html>
