<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head'); %>
    <title>Wheels</title>
    <%- include('../partials/analytics'); %>
</head>
<body>
    <%- include('../partials/header'); %>
    <div class="container">
        <div class="row pt-4">
            <div class="col">
                <h1 style="font-weight: bold;">Wheels</h1>
            </div>
        </div>
        <div class="d-flex flex-wrap gap-2 mb-3">
            <div class="d-flex flex-wrap gap-2 mb-3 w-100">
                <%
                    const hasCorvette = model_list.some(m => m.startsWith('CORVETTE'));
                    const combinedModels = hasCorvette ? ['CORVETTE (ALL)', ...model_list] : model_list;
                    combinedModels.sort((a, b) => a.localeCompare(b));
                %>
                <div class="statsDropdown">
                    <select id="filterModel" class="form-select small-dropdown">
                        <option value="">Model</option>
                        <% combinedModels.forEach(m => { %>
                            <option value="<%= m %>"><%= m %></option>
                        <% }) %>
                    </select>
                </div>
            </div>
        </div>

        <div id="top-scroll-wrapper">
            <div id="top-scroll"></div>
        </div>
        <div class="table-responsive" id="bottom-scroll-wrapper">
            <table class="table-stats-veh table-hover border shadow" id="wheelTable" style="display: none;">
                <thead>
                    <tr>
                        <th scope="col">Wheel</th>
                        <th scope="col">RPO</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <%- include('../partials/footer'); %>
    <script>
        const camaroRpo = <%- JSON.stringify(camaroRpo) %>;
        const corvetteRpo = <%- JSON.stringify(corvetteRpo) %>;
        const escaladeRpo = <%- JSON.stringify(escaladeRpo) %>;
        const escaladeiqRpo = <%- JSON.stringify(escaladeiqRpo) %>;
        const ct4Rpo = <%- JSON.stringify(ct4Rpo) %>;
        const ct4vRpo = <%- JSON.stringify(ct4vRpo) %>;
        const ct5Rpo = <%- JSON.stringify(ct5Rpo) %>;
        const ct5vRpo = <%- JSON.stringify(ct5vRpo) %>;
        const localRpoImageMap = <%- JSON.stringify(localRpoImageMap) %>;

        let rpoDescriptions = {};
        const rpoDescriptionCache = {};

        const modelRpoMap = {
            'CAMARO': [
                'REG', 'SGE', '5K9', '57V', '56F', 'SHH', 'SRI', '58E', 'SHL', '56H', 'RQ9',
                'RTJ', '56R', '5JX', '57S', '56W', 'RQA', '56S', 'RTH', '56V', 'Q7F', '56Y',
                'SKW', '56M', 'WR1', '5JW', '57W', '56K', 'Q7G', '56Z', 'RSK', 'RTQ', 'PKJ'
            ],
            'CT4': ['RID', '58F', 'Q7B', 'PZJ', 'Q6Z', 'RT2', 'SOX', 'SPQ', 'SOY', 'SGV', 'SOU', 'R38', 'R37', 'RRR'],
            'CT5': ['QE1', 'Q81', '57R', 'RQL', 'Q84', 'Q83', '57M', 'Q82', 'SQ9', 'SKW', 'SKX', 'Q7N', 'SSE', 'SSJ', 'Q63', 'Q61', 'RHL'],
            'CT6': ['PTW', 'RT9', 'Q6M', 'PXX', 'RTH', 'RTJ', 'RQ9', '5JO', 'SHH'],
            'ESCALADE': ['SET', 'SSX', 'SQO', 'SSV', '5FD', '5FE', 'SML', 'R4E', 'R4F', 'R4D', 'SMM', 'RF5', 'R5D', 'RF7', 'SGG'], // Only 2025-2026 currently
            'ESCALADE IQ': ['RDP', 'SF3'],
            'CORVETTE ZR1': ['SOJ', 'SOG', 'SOF', 'SOH', 'SU1'],
            'CORVETTE ZR1X': ['SOJ', 'SOG', 'SOF', 'SOH', 'SU1'],
            'CORVETTE Z06': ['SOE', 'SOA', 'SRK', 'SRN', 'STE', 'STX', '5DK', '5DH', 'ROY', 'ROZ', 'STZ', '5DH'],
            'CORVETTE E-RAY': ['ROU', 'SON', 'ROX', 'SOM', 'ROY', 'ROZ', 'STZ'],
            'CORVETTE STINGRAY': ['5DG', '5DO', 'Q8P', 'Q8Q', 'Q9Y', 'Q9O', 'Q99', 'Q9I', 'Q9A', '5DG', 'QE5'],
            'CORVETTE (ALL)': ['Q9A', '5DG', 'Q9Y', '5DO', 'Q9O', 'Q9I', 'Q99', 'Q8Q', 'Q8P', 'QE5', 'Q7Q', 'Q7Z', 'Q8W', 'Q8X', 'Q8P', 'Q8Q', 'Q9Y', 'Q9O', 'Q99', 'Q9I', 'Q9A', '5DG', 'QE5', 'ROU', 'SON', 'ROX', 'SOM', 'ROY', 'ROZ', 'STZ', 'SOE', 'SOA', 'SRK', 'SRN', 'STE', 'STX', '5DK', '5DH', 'STZ', 'SOJ', 'SOG', 'SOF', 'SOH', 'SU1']
        };

        function loadRpoDescriptions() {
            const cached = sessionStorage.getItem('rpoCodes');
            if (cached) {
                const data = JSON.parse(cached);
                data.allRpoCodes.forEach(([code, desc]) => {
                    rpoDescriptions[code] = desc;
                });
                return Promise.resolve();
            } else {
                return fetch('https://decoderpo.com/static/rpoCodes.json')
                    .then(res => res.json())
                    .then(data => {
                        sessionStorage.setItem('rpoCodes', JSON.stringify(data));
                        data.allRpoCodes.forEach(([code, desc]) => {
                            rpoDescriptions[code] = desc;
                        });
                    })
                    .catch(err => {
                        console.error('Failed to load RPO data:', err);
                    });
            }
        }

        const getLocalRpoDescription = (rpoCode, model) => {
            switch (model) {
                case 'CT4':
                    if (ct4Rpo[rpoCode]) return ct4Rpo[rpoCode];
                    if (ct4vRpo[rpoCode]) return ct4vRpo[rpoCode];
                    return null;
                case 'CT5':
                    if (ct5Rpo[rpoCode]) return ct5Rpo[rpoCode];
                    if (ct5vRpo[rpoCode]) return ct5vRpo[rpoCode];
                    return null;
                case 'CAMARO':
                    return camaroRpo[rpoCode];
                case 'ESCALADE':
                    return escaladeRpo[rpoCode];
                case 'ESCALADE IQ':
                    return escaladeiqRpo[rpoCode];
                default:
                    if (model.startsWith('CORVETTE')) return corvetteRpo[rpoCode];
                    return null;
            }
        };
        
        const getWheelImageUrl = (rpoCode, outsourcedUrl, model) => {
            const key = `${model}-${rpoCode}`;
            if (localRpoImageMap[key]) return localRpoImageMap[key];
            if (localRpoImageMap[rpoCode]) return localRpoImageMap[rpoCode]; // fallback
            return outsourcedUrl;
        };

        document.addEventListener('DOMContentLoaded', function () {
            const modelSelect = document.getElementById('filterModel');
            const table = document.getElementById('wheelTable');
            const tableBody = table.querySelector('tbody');
            const url = new URL(window.location.href);

            modelSelect.addEventListener('change', function () {
                const selectedModel = this.value?.toUpperCase();
                tableBody.innerHTML = '';

                if (selectedModel) url.searchParams.set('model', selectedModel);
                else url.searchParams.delete('model');
                history.replaceState(null, '', url.toString());

                if (selectedModel && modelRpoMap[selectedModel]) {
                    let modelLower = selectedModel.toLowerCase().replace(/ /g, '-').replace('e-ray', 'eray');
                    if (selectedModel === 'CORVETTE STINGRAY' || selectedModel === 'CORVETTE (ALL)') modelLower = 'corvette';
                    const category = modelLower.startsWith('corvette') ? 'corvette' : modelLower;
                    const year = (selectedModel === 'CAMARO') ? '2024' : '2025';
                    const cadillacModels = ['ESCALADE', 'ESCALADE IQ', 'CT4', 'CT5', 'CT6', 'CT4V', 'CT5V'];
                    const manufacturer = cadillacModels.includes(selectedModel) || selectedModel.startsWith('CT') || selectedModel.startsWith('ESCALADE') ? 'cadillac' : 'chevrolet';

                    const rposToRender = selectedModel === 'CORVETTE (ALL)' 
                        ? [...new Set(modelRpoMap['CORVETTE ZR1'].concat(modelRpoMap['CORVETTE Z06'], modelRpoMap['CORVETTE E-RAY'], modelRpoMap['CORVETTE STINGRAY']))]
                        : modelRpoMap[selectedModel];


                    rposToRender.forEach(rpo => {
                        const row = document.createElement('tr');
                        let imgRpo = rpo;
                        if (rpo === '5K9') imgRpo = '57V';
                        if (rpo === '5JW') imgRpo = 'WR1';
                        const outsourcedUrl = `https://www.${manufacturer}.com/bypass/master_tools/ddp/gmna/assets/US/${manufacturer}/${year}/${category}/${modelLower}/small_byo3/${imgRpo}.jpg`;
                        const finalImageUrl = getWheelImageUrl(imgRpo, outsourcedUrl, selectedModel);
                        row.innerHTML = `
                            <td>
                                <img 
                                    class="wheel-image"
                                    data-rpo="${imgRpo}"
                                    src="${finalImageUrl}"
                                    alt="Wheel Image"
                                    style="height: 200px; width: auto;"
                                    onerror="
                                        // Outsourced URL fallback for year (if present)
                                        if (this.src.includes('bypass/master_tools') && !this.dataset.fallback) {
                                            this.dataset.fallback = 'true';
                                            this.src = this.src.replace('/${year}/', '/2024/');
                                        } 
                                        // Final fallback to generic placeholder
                                        else if (!this.dataset.placeholder) {
                                            this.dataset.placeholder = 'true';
                                            this.src = '/img/placeholder-wheel.png'; 
                                        }
                                    "
                                />
                            </td>
                            <td style="text-align: left;">
                                <strong>${rpo}</strong>
                                <div class="rpo-description" data-code="${rpo}" style="margin-top: 4px;"></div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });

                    table.style.display = 'table';

                    document.querySelectorAll('.rpo-description').forEach(element => {
                        const rpoCode = element.getAttribute('data-code');
                        const model = modelSelect.value?.toUpperCase();

                        if (rpoDescriptionCache[rpoCode]) {
                            element.innerHTML = rpoDescriptionCache[rpoCode];
                            return;
                        }

                        const applyFormatting = (desc, isLocal = false) => {
                            let lines = Array.isArray(desc) ? desc : [desc];
                            const formattedLines = lines.map(line =>
                                line.replace(/forged/gi, '<strong>forged</strong>')
                                    .replace(/carbon fiber/gi, '<strong>carbon fiber</strong>')
                            );
                            const html = formattedLines.map(line => `<div class="rpo-${isLocal ? 'local' : 'outsourced'}">${line}</div>`).join('');
                            element.innerHTML = html;
                            rpoDescriptionCache[rpoCode] = html;

                            const row = element.closest('tr');
                            const descText = lines.join(' ').toLowerCase();
                            if (descText.includes('forged')) row.style.border = '4px solid #494949';
                            if (descText.includes('carbon')) row.style.border = '4px solid #242424';
                        };

                        const localDescription = getLocalRpoDescription(rpoCode, model);
                        
                        if (localDescription) {
                            applyFormatting(localDescription, true);
                            return;
                        }

                        if (rpoDescriptions[rpoCode]) {
                            applyFormatting(rpoDescriptions[rpoCode], false);
                        } else {
                            fetch(`https://decoderpo.com/api/getRPODescription/${rpoCode}`)
                                .then(resp => {
                                    if (!resp.ok) throw new Error('Not found');
                                    return resp.json();
                                })
                                .then(data => {
                                    const decoded = atob(data[0]);
                                    const lines = JSON.parse(decoded);
                                    applyFormatting(lines, false);
                                })
                                .catch(() => {
                                    element.textContent = 'Not found';
                                    rpoDescriptionCache[rpoCode] = 'Not found';
                                });
                        }
                    });
                } else {
                    table.style.display = 'none';
                }
            });

            loadRpoDescriptions().then(() => {
                const initialModel = url.searchParams.get('model')?.toUpperCase();
                if (initialModel && modelRpoMap[initialModel]) {
                    modelSelect.value = initialModel;
                    modelSelect.dispatchEvent(new Event('change'));
                }
            });
        });
    </script>
</body>
</html>
