<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head'); %>
    <title>RPOs</title>
    <%- include('../partials/analytics'); %>
</head>
<body>
    <%- include('../partials/header'); %>
    <div class="container">
        <div class="row pt-4">
            <div class="col">
                <h1 style="font-weight: bold;">RPOs</h1>
            </div>
        </div>
        <div class="d-flex flex-wrap gap-2 mb-3">
            <div class="statsDropdown">
                <select id="modelSelect" class="form-select small-dropdown">
                    <option value="">Select Model</option>
                    <option value="camaro">Camaro</option>
                    <option value="corvette">Corvette</option>
                    <option value="ct4">CT4</option>
                    <option value="ct4v">CT4-V</option>
                    <option value="ct5">CT5</option>
                    <option value="ct5v">CT5-V</option>
                    <option value="escaladeiq">Escalade IQ</option>
                </select>
            </div>
        </div>
        <div class="rpo-container" id="rpoContainer"></div>
    </div>
    <%- include('../partials/footer'); %>

    <script>
        const container = document.getElementById('rpoContainer');
        const modelSelect = document.getElementById('modelSelect');

        const allRpos = {
            camaro: <%- JSON.stringify(camaroRpo) %>,
            corvette: <%- JSON.stringify(corvetteRpo) %>,
            escaladeiq: <%- JSON.stringify(escaladeiqRpo) %>,
            ct4: <%- JSON.stringify(ct4Rpo) %>,
            ct4v: <%- JSON.stringify(ct4vRpo) %>,
            ct5: <%- JSON.stringify(ct5Rpo) %>,
            ct5v: <%- JSON.stringify(ct5vRpo) %>,
        };

        function renderRPOs(model) {
            container.innerHTML = '';
            const rpos = allRpos[model];
            const missingRpos = [];

            Object.keys(rpos).forEach(rpo => {
                const link = document.createElement('a');
                link.href = `/vehicles?model=${model}&rpo=${rpo}`;
                link.style.textDecoration = 'none';
                link.style.display = 'block';

                const card = document.createElement('div');
                card.className = 'rpo-card';

                const img = document.createElement('img');
                img.src = `../img/rpos/${model}/${rpo}.jpg`;
                img.alt = rpo;
                img.onerror = function() {
                    if (!this.dataset.fallback) {
                        this.dataset.fallback = 'true';
                        const cadillacModels = ['escaladeiq', 'ct4', 'ct4v', 'ct5', 'ct5v'];
                        let imagePath = '../img/';
                        if (cadillacModels.includes(model)) {
                            imagePath += 'cadillac-brand-logo.png';
                        } else {
                            imagePath += 'chevrolet-brand-logo.png';
                        }
                        this.src = imagePath;
                        missingRpos.push(rpo);
                    }
                };

                const title = document.createElement('strong');
                title.textContent = rpo;

                const descDiv = document.createElement('div');
                descDiv.className = 'rpo-description';
                const desc = rpos[rpo];
                const lines = Array.isArray(desc) ? desc : [desc];
                descDiv.innerHTML = lines.map(line => `<div>${line}</div>`).join('');

                card.appendChild(img);
                card.appendChild(title);
                card.appendChild(descDiv);
                link.appendChild(card);
                container.appendChild(link);
            });

            setTimeout(() => {
                // if (missingRpos.length > 0) downloadMissingRpos(missingRpos);
            }, 5000);
        }

        function downloadMissingRpos(list) {
            const blob = new Blob([list.join('\n')], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'missing_rpos.txt';
            a.click();
            URL.revokeObjectURL(a.href);
        }

        modelSelect.addEventListener('change', e => renderRPOs(e.target.value));

        renderRPOs(modelSelect.value);
    </script>
</body>
</html>
