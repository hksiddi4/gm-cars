<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head'); %>
    <% const vin = vin_data[0]; %>
    <title>
      <%= (vin.modelYear ? "'" + vin.modelYear.toString().slice(-2) : 'N/A') %>
      <%= vin.model || 'N/A' %> 
      <%= vin.trim || 'N/A' %> 
    </title>
</head>
<body>
  <%- include('../partials/header'); %>
    <div class="custom-container">
        <div class="row">
          <% if (vin_data && vin_data.length > 0) { %>
            <h1 style="padding-top: 20px;">
              <%= vin.modelYear || 'N/A' %>
              <%= vin.model || 'N/A' %>
              <%= vin.trim || 'N/A' %>
            </h1>
            <% if (vin.special_descs && vin.special_descs !== 'NA') { %>
              <div>
                <h4>
                  <em>
                    <% 
                      // Split the special_descs by comma and iterate over each description
                      const specialDescs = vin.special_descs.split(', ');
                      specialDescs.forEach(desc => { 
                    %>
                      <div><%= desc %></div>
                    <% }); %>
                  </em>
                </h4>
              </div>
            <% } %>
        </div>
        <div style="display: flex; gap: 10px; align-items: flex-start; padding: 10px;">
            <!-- Photo Carousel -->
            <div id="carousel-container" style="flex: 1; max-width: 867px; position: relative; min-height: 400px; overflow: hidden;">
              <div id="loading-animation">
                <div class="spinner" style="position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); align-items: center;"></div>
                <h4 style="position: absolute; top: 58%; left: 50%; transform: translate(-50%, -50%); align-items: center;">Generating Photos...</h4>
                <h4 style="position: absolute; top: 70%; left: 50%; transform: translate(-50%, -50%); align-items: center;">This will take a minute.</h4>
              </div>
              <img id="carousel-image" src="" style="width: 100%;">
              <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                <button id="prev" style="position: absolute; top: 50%; left: 0; background-color: rgba(0, 0, 0, 0.5); color: white; border: none; padding: 10px; cursor: pointer; z-index: 100;">&#10094;</button>
                <button id="next" style="position: absolute; top: 50%; right: 0; background-color: rgba(0, 0, 0, 0.5); color: white; border: none; padding: 10px; cursor: pointer; z-index: 100;">&#10095;</button>
              </div>
            </div>
            <div id="image-gallery" style="margin-top: 10px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; overflow-x: hidden; justify-content: flex-start; max-height: 478px;"></div>
            <div style="flex: 1;">
              <table class="table-veh table-hover border shadow" id="vinTable">
                <tbody>
                    <% vin_data.forEach(function(data) { %>
                    <tr>
                      <td class="label-column"><strong>VIN</strong></td>
                      <td><%= data.vin || 'N/A' %></td>
                    </tr>
                    <tr>
                      <td class="label-column"><strong>ORDER NUMBER</strong></td>
                      <td><%= data.order_number || 'N/A' %></td>
                    </tr>
                    <tr>
                      <td class="label-column"><strong>STICKER CREATION DATE</strong></td>
                      <td>
                        <%= data.formatted_date || 'N/A' %>
                      </td>
                    </tr>
                    <tr>
                      <td class="label-column"><strong>YEAR</strong></td>
                      <td><%= data.modelYear || 'N/A' %></td>
                    </tr>
                    <tr>
                      <td class="label-column"><strong>MODEL</strong></td>
                      <td><%= data.model || 'N/A' %></td>
                    </tr>
                    <tr>
                      <td class="label-column"><strong>TRIM</strong></td>
                      <td><%= data.trim || 'N/A' %></td>
                    </tr>
                    <tr>
                      <td class="label-column"><strong>BODY</strong></td>
                      <td><%= data.body || 'N/A' %></td>
                    </tr>
                    <tr>
                      <td class="label-column"><strong>ENGINE</strong></td>
                      <td><%= data.engine_type || 'N/A' %></td>
                    </tr>
                    <tr>
                      <td class="label-column"><strong>TRANSMISSION</strong></td>
                      <td><%= data.transmission_type || 'N/A' %></td>
                    </tr>
                    <tr>
                      <td class="label-column"><strong>DRIVETRAIN</strong></td>
                      <td><%= data.drivetrain_type || 'N/A' %></td>
                    </tr>
                    <tr>
                      <td class="label-column"><strong>EXTERIOR COLOR</strong></td>
                      <td><%= data.color_name || 'N/A' %></td>
                    </tr>
                    <% if (data.rpo_codes) { %>
                      <%
                        let matchedIntColor = 'N/A';
                        let matchedSeat = 'N/A';
                        data.rpo_codes.forEach(function(rpo) {
                          if (intColor[rpo]) {
                            matchedIntColor = intColor[rpo];
                          }
                          if (seatCode[rpo]) {
                            matchedSeat = seatCode[rpo];
                          }
                        });
                      %>
                    <tr>
                      <td class="label-column"><strong>INTERIOR COLOR</strong></td>
                      <td><%= matchedIntColor.toUpperCase() %></td>
                    </tr>
                    <tr>
                      <td class="label-column"><strong>SEAT</strong></td>
                      <td><%= matchedSeat.toUpperCase() %></td>
                    </tr>
                    <% } %>
                    <tr>
                      <td class="label-column"><strong>MSRP</strong></td>
                      <td><%= (!data.msrp || data.msrp == 0) ? 'N/A' : `$${data.msrp}` %></td>
                    </tr>                  
                    <tr>
                      <td class="label-column"><strong>DEALER</strong></td>
                      <td><%= data.dealer_name || 'N/A' %></td>
                    </tr>
                    <tr>
                      <td class="label-column"><strong>LOCATION</strong></td>
                      <td><%= data.location || 'N/A' %></td>
                    </tr>
                    <tr>
                      <td class="label-column"><strong>COUNTRY</strong></td>
                      <td>
                        <% if (data.country) { %>
                          <% if (data.country === 'CANADA') { %>
                            <img src="../img/flags/canada_flag.png" alt="Canada" width="30" style="margin-right: 5px;">CANADA
                          <% } else if (data.country === 'USA') { %>
                            <img src="../img/flags/usa_flag.png" alt="USA" width="30" style="margin-right: 5px;">UNITED STATES
                          <% } else if (data.country === 'MEXICO') { %>
                            <img src="../img/flags/mexico_flag.png" alt="Mexico" width="30" style="margin-right: 5px;">Mexico
                          <% } %>
                        <% } %>
                      </td>
                    </tr>
                    <% }) %>
                </tbody>
              </table>
            </div>
        </div>
    </div>
    <div class="custom-container">
        <div style="display: flex; gap: 10px; align-items: flex-start; padding: 10px;">
            <!-- Window Sticker -->
            <div id="sticker-container" style="flex: 1;">
              <% if (vin.country === 'MEXICO') { %>
                <h2>No window sticker available</h2>
              <% } else { %>
                <iframe id="window-sticker" src="https://cws.gm.com/vs-cws/vehshop/v2/vehicle/windowsticker?vin=<%= vin.vin || 'N/A' %>" style="min-height: 886px; width: 100%;"></iframe>
              <% } %>
            </div>
            <!-- <div class="rarity-container">
              <% vin_data.forEach(function(data) { %>
                <% if (data.allJson) { %>
                  <button id="see-rarity" class="btn btn-primary rarity-btn" data-alljson='<%= JSON.stringify(data.allJson) %>'>See Rarity</button>
                <% } %>
              <% }); %>
              <div class="response-container">
                <div id="response" class="response"></div>
                <div><a id="snark" style="color: rgb(40, 40, 40);"></a></div>
              </div>
            </div> -->
            <div style="flex: 1; max-height: 825px; overflow-y: auto;">
              <table class="table-veh table-hover border border shadow" id="rpoTable">
                <thead>
                  <tr>
                    <th scope="col" style="white-space: nowrap;">RPO Code</th>
                    <th scope="col">Description</th>
                  </tr>
                </thead>
                <tbody>
                  <% vin_data.forEach(function(data) { %>
                    <% if (data.rpo_codes) { %>
                      <% data.rpo_codes.forEach(function(rpo) { %>
                        <% if (rpo) { %>
                          <tr style="cursor: pointer;" onmousedown="handleMouseDown(event);" data-url="/vehicles?rpo=<%= rpo %>">
                            <td class="<%= rpo.includes('OAR') ? 'highlight' : '' %>"><%= rpo %></td>
                            <td class="rpo-description" data-code="<%= rpo %>" style="text-align: left;"></td>
                          </tr>
                        <% } %>
                      <% }); %>
                    <% } else { %>
                      <tr>
                        <td colspan="2">No data available</td>
                      </tr>
                    <% } %>
                  <% }) %>
                </tbody>
              </table>
            </div>
        </div>
        <% } else { %>
          <h1>No VIN data found</h1>
        <% } %>
    </div>
    <%- include('../partials/footer'); %>
    <script>
      function handleMouseDown(event) {
        startX = event.clientX;
      }

      function handleRowClick(url, event) {
        const distance = Math.abs(event.clientX - startX);
        if (distance > 5) return;
        window.location.href = url;
      }

      function loadImageWithRetry(url, retries = 3, delay = 1000) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(url);
          img.onerror = () => {
            if (retries > 0) {
              setTimeout(() => {
                loadImageWithRetry(url, retries - 1, delay).then(resolve).catch(reject);
              }, delay);
            } else {
              reject(url);
            }
          };
          img.src = url;
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.rpo-description').forEach(function(element) {
          const rpoCode = element.getAttribute('data-code');
          fetch(`https://decoderpo.com/api/getRPODescription/${rpoCode}`)
            .then(response => {
              if (!response.ok) throw new Error('Not found');
              return response.json();
            })
            .then(data => {
              const base64 = data[0];
              const decoded = atob(base64);
              const lines = JSON.parse(decoded);
              if (Array.isArray(lines) && lines.length > 0) {
                element.innerHTML = lines.map(line => `<div>${line}</div>`).join('');
              }
            })
            .catch(() => {
              element.textContent = 'Not found';
            });
        });

        const carouselImage = document.getElementById('carousel-image');
        const loadingAnimation = document.getElementById('loading-animation');
        loadingAnimation.style.display = 'block';

        const mmc = <%- JSON.stringify(mmc) %>;
        const colorMap = <%- JSON.stringify(colorMap) %>;
        const intColor = <%- JSON.stringify(intColor) %>;
        const vin_data = <%- JSON.stringify(vin_data) %>;
        const ghostImg = "../img/ghost-chevrolet-car-alt.png";

        const modelYear = vin_data[0].modelYear;
        const mmc_code = vin_data[0].mmc_code;
        const options = vin_data[0].rpo_codes || [];

        let trim = mmc[mmc_code] || '';
        if (["1YC07", "1YC67"].includes(mmc_code)) {
          trim = options.find(opt => ["1LT", "2LT", "3LT"].includes(opt)) || trim;
        } else if (["1YH07", "1YH67", "1YG07", "1YG67", "1YR07", "1YR67"].includes(mmc_code)) {
          trim = options.find(opt => ["1LZ", "2LZ", "3LZ"].includes(opt)) || trim;
        }

        const rpos = options.join('_');
        const color = options.find(opt => Object.values(colorMap).includes(opt));
        const colorInt = options.find(opt => Object.keys(intColor).includes(opt));
        const modelUpper = vin_data[0].model ? vin_data[0].model.toUpperCase() : '';
        let extMax = modelUpper === 'CAMARO' ? 4 : 7;
        let intMax = modelUpper === 'CAMARO' ? 2 : 4;

        let urls = [];

        console.log(`https://cgi.chevrolet.com/mmgprod-us/dynres/prove/image.gen?i=${modelYear}/${mmc_code}/${mmc_code}__${trim}/${color}_${rpos}gmds10.png&v=deg01&std=true&country=US&send404=true&transparentBackgroundPng=true`);

        if (modelYear && mmc_code && trim && color && colorInt) {
          for (let i = 1; i <= extMax; i++) {
            urls.push(`https://cgi.chevrolet.com/mmgprod-us/dynres/prove/image.gen?i=${modelYear}/${mmc_code}/${mmc_code}__${trim}/${color}_${rpos}gmds10.png&v=deg${String(i).padStart(2, '0')}&std=true&country=US&send404=true&transparentBackgroundPng=true`);
          }
          for (let i = 1; i <= intMax; i++) {
            urls.push(`https://cgi.chevrolet.com/mmgprod-us/dynres/prove/imageinterior.gen?i=${modelYear}/${mmc_code}/${mmc_code}__${trim}/${colorInt}_${rpos}gmds10.png&v=deg${String(i).padStart(2, '0')}&std=true&country=US&send404=true&transparentBackgroundPng=true`);
          }
        } else {
          urls = [ghostImg];
        }

        const gallery = document.getElementById('image-gallery');
        urls.forEach((imgSrc, index) => {
          const thumb = document.createElement('img');
          thumb.src = imgSrc;
          thumb.alt = `Thumbnail ${index + 1}`;
          thumb.style.width = '100px';
          thumb.style.cursor = 'pointer';
          thumb.style.border = '2px solid transparent';
          thumb.addEventListener('click', () => {
            showImage(index);
          });
          gallery.appendChild(thumb);
        });

        let currentIndex = 0;
        let initialLoad = true;

        function preloadImage(src) {
          const img = new Image();
          img.src = src;
        }

        function showImage(index) {
          while (urls[index] === null) {
            index = (index + 1) % urls.length;
            if (index === currentIndex) break;
          }
          currentIndex = index;
          const imgSrc = urls[index];

          loadImageWithRetry(imgSrc, 3, 1200).then((validUrl) => {
            if (initialLoad) {
              carouselImage.onload = () => {
                loadingAnimation.style.display = 'none';
                initialLoad = false;
              };
            } else {
              carouselImage.style.opacity = 0;
              setTimeout(() => {
                carouselImage.onload = () => {
                  carouselImage.style.opacity = 1;
                };
              }, 200);
            }
            carouselImage.src = validUrl;
            carouselImage.alt = `Image ${index + 1}`;
          }).catch(() => {
            carouselImage.src = ghostImg;
            loadingAnimation.style.display = 'none';
          });

          [...gallery.children].forEach((img, i) => {
            img.style.border = (i === index && urls[i]) ? '2px solid #141414' : '2px solid transparent';
          });

          let nextIndex = (index + 1) % urls.length;
          while (urls[nextIndex] === null && nextIndex !== index) {
            nextIndex = (nextIndex + 1) % urls.length;
          }
          if (urls[nextIndex]) preloadImage(urls[nextIndex]);
        }

        showImage(currentIndex);

        document.getElementById('prev').addEventListener('click', () => {
          let prevIndex = currentIndex;
          do {
            prevIndex = (prevIndex === 0) ? urls.length - 1 : prevIndex - 1;
          } while (urls[prevIndex] === null && prevIndex !== currentIndex);
          showImage(prevIndex);
        });

        document.getElementById('next').addEventListener('click', () => {
          let nextIndex = currentIndex;
          do {
            nextIndex = (nextIndex === urls.length - 1) ? 0 : nextIndex + 1;
          } while (urls[nextIndex] === null && nextIndex !== currentIndex);
          showImage(nextIndex);
        });

        document.querySelectorAll('#rpoTable tbody tr').forEach(row => {
          const url = row.getAttribute('data-url');
          row.addEventListener('mousedown', handleMouseDown);
          row.addEventListener('click', (event) => handleRowClick(url, event));
        });
      });
    </script>
</body>

</html>
