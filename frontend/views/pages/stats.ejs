<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head'); %>
    <title>Stats</title>
</head>
<body>
    <%- include('../partials/header'); %>
    <div class="container">
        <div class="row pt-4">
            <div class="col">
                <h1 style="font-weight: bold;">Statistics</h1>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-md-2">
                <select id="selectedStats" class="form-select">
                    <option value="">Category</option>
                    <option value="color" <% if (category === 'color') { %> selected <% } %>>Color</option>
                </select>
            </div>
        </div>
        <% if (stats_data && stats_data.length > 0) { %>
            <canvas id="barChart"></canvas>
            <table class="table-veh table-hover border shadow">
                <thead>
                    <tr>
                        <th scope="col">
                            Rank
                        </th>
                        <th scope="col">
                            RPO
                        </th>
                        <th scope="col">
                            Count
                        </th>
                        <th scope="col">
                            Names
                        </th>
                        <th scope="col">
                            % of Total
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <% stats_data.forEach(function(data) { %>
                        <tr>
                            <td scope="row"><%= data.rank %></td>
                            <td scope="row" style="display: flex; align-items: center;">
                                <img id="sample" src="../img/extColors/<%= data.rpo_code || '../extColors/default' %>.png" width="20" height="20" style="margin-right: 8px; border-radius: 50%;">
                                <%= data.rpo_code %>
                            </td>
                            <td scope="row"><%= data.total_count %></td>
                            <td scope="row" style="text-align: left;">
                            <% data.color_names.split(',').forEach((name, i) => { %>
                                <a href="/vehicles?color=<%= encodeURIComponent(name.trim()) %>"><%= name.trim() %></a><%= i < data.color_names.split(',').length - 1 ? ', ' : '' %>
                            <% }) %>
                            </td>
                            <td scope="row"><%= data.percent %>%</td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } %>
    </div>
    <%- include('../partials/footer'); %>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const statsSelect = document.getElementById('selectedStats');
            
            statsSelect.addEventListener('change', function () {
                const selectedValue = this.value;
                const url = new URL(window.location.href);
                url.searchParams.set('category', selectedValue);
                window.location.href = url.toString();
            });
        });
    </script>
    <% if (stats_data && stats_data.length > 0) { %>
        <script>
            const stats_data = <%- JSON.stringify(stats_data) %>;
        </script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                let rawData = stats_data.map(data => ({
                    label: data.rpo_code || '',
                    count: Number(String(data.total_count).replace(/,/g, '')) || 0
                }));

                rawData.sort((a, b) => a.count - b.count);
                rawData = rawData.slice(0, 20);

                const labels = rawData.map(d => d.label);
                const counts = rawData.map(d => d.count);

                const ctx = document.getElementById('barChart').getContext('2d');

                Chart.register(ChartDataLabels);

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Count',
                            data: counts,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            borderRadius: 2,
                            barPercentage: 1,
                            categoryPercentage: 0.8
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        scales: {
                        y: {
                            type: 'category',
                            ticks: {
                                autoSkip: false,
                                color: '#ffffff',
                                font: { size: 10 }
                            }
                        },
                        x: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                callback: function (value) {
                                    if (value >= 1e6) return (value / 1e6).toFixed(1) + 'M';
                                    if (value >= 1e3) return (value / 1e3).toFixed(1) + 'k';
                                    return value;
                                }
                            }
                        }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Top 20 Rarest Colors',
                                color: '#ffffff',
                                font: { size: 20 }
                            },
                            datalabels: {
                                color: '#ffffff',
                                align: 'end',
                                anchor: 'right',
                                formatter: (value) => value.toLocaleString(),
                            },
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                label: ctx => `Count: ${ctx.parsed.x.toLocaleString()}`
                                }
                            }
                        }
                    }
                });
            });
        </script>
    <% } %>
</body>
</html>
